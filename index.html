
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <title>Winter Journey Planner</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap');
        :root { --paper: #F9F7F2; --accent: #8E2B2B; --gold: #B59F7A; }
        body { background-color: var(--paper); font-family: 'Noto Serif TC', serif; color: #2D2D2D; overflow-x: hidden; }
        .main-section.hidden, 
        .hidden {
            display: none !important;
            visibility: hidden !important;
            height: 0 !important;
            overflow: hidden !important;
        }
        .timeline-line::before {
            content: ''; position: absolute; left: 19px; top: 0; bottom: 0; width: 1px;
            background: repeating-linear-gradient(to bottom, var(--gold) 0, var(--gold) 4px, transparent 4px, transparent 8px);
        }
        .tab-active { color: var(--accent) !important; border-bottom: 2px solid var(--accent) !important; font-weight: bold; }
        .sortable-ghost { opacity: 0.3; background: #e2e2e2; }
        .op-active {background-color: white !important;color: #8E2B2B !important;}
        .scrollbar-hide::-webkit-scrollbar {display: none;}
        .scrollbar-hide {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */}
        #hourly-forecast {
            display: flex !important;
            flex-wrap: nowrap;
            -webkit-overflow-scrolling: touch;
        }
        #hourly-forecast > div {
            flex-shrink: 0; /* é˜²æ­¢å°æ™‚è³‡è¨Šè¢«å£“ç¸® */
        }
        /* ğŸ›ï¸ è³¼ç‰©æ¸…å–®å½ˆçª— - æ„›å¿ƒäº’å‹•å€å„ªåŒ– */
        .heart-emoji-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px; /* ç¨å¾®ç¸®å°ä¸€é»é»ï¼Œç¢ºä¿ä¸æ“ å£“ */
            height: 32px;
            cursor: pointer;
            font-size: 1.5rem; /* ç´„ 24px */
            line-height: 1;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            user-select: none;
        }
        .heart-emoji-btn:active {transform: scale(0.8);}
        .heart-active {
            transform: scale(1.1); /* ä¸è¦æ”¾å¤ªå¤§ï¼Œé¿å…ç ´æ¡† */
            filter: drop-shadow(0 2px 4px rgba(251, 113, 133, 0.2));}
        #heart-tag {
            white-space: nowrap;
            min-width: 45px;
            text-align: center;
        }
        /* è®“å¤šåœ–æ©«å‘æ»‘å‹•æ™‚éš±è—æ»¾å‹•æ¢ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar {display: none;}
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* å°‡é€™æ®µè²¼åœ¨ <style> æ¨™ç±¤å…§ */
        .header-container::before {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            
        /* ğŸŒŸ åœ¨é€™è£¡è²¼ä¸Šä½ çš„ç…§ç‰‡ç¶²å€ */
        background-image: linear-gradient(to bottom, rgba(255,255,255,0.4), rgba(255,255,255,0.7)), 
                        url('https://banbi.tw/wp-content/uploads/20230224042032_12.jpg');
                            
        background-size: cover;
        background-position: center;
        filter: blur(0px); /* é€™è£¡æ§åˆ¶æ¨¡ç³Šç¨‹åº¦ */
        transform: scale(1.1); /* æ”¾å¤§ä¸€é»é»é¿å…é‚Šç·£ç™½é‚Š */
        z-index: 0;
        }
        /* è®“è¡Œç¨‹æ¨™é¡Œèƒ½å¤ æ­£å¸¸æ›è¡Œï¼Œä¸æœƒæ’é–‹å®¹å™¨ */
        .break-words {
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-all; /* é‡å°é•·è‹±æ–‡æˆ–ç„¡ç©ºæ ¼æ–‡å­—å¼·åˆ¶æ–·è¡Œ */
            white-space: normal;   /* ç¢ºä¿ä¸æœƒå¼·åˆ¶åœ¨åŒä¸€è¡Œ */
            display: block;        /* ç¢ºä¿å®ƒä½”æ“šæ­£ç¢ºçš„æ–¹å¡Šç©ºé–“ */
        }

        /* é™åˆ¶æ¨™é¡Œå€å¡Šçš„æœ€å¤§å¯¬åº¦ï¼Œé¿å…æ“ å£“åˆ°å³å´çš„åœ–æ¨™ */
        .event-title-container {
            max-width: calc(100% - 30px); 
        }
        
    </style>
</head>
<body class="pb-24">
    <header class="header-container relative flex h-80 flex-col justify-between p-5 text-gray-800 overflow-hidden">    
        <div class="w-full pt-2 relative z-10">
            <p class="text-[15px] tracking-tight opacity-90 font-bold whitespace-nowrap">
                2026.02.10-02.19 <span class="mx-2 text-gray-800">|</span> <span class="italic text-gold">é—œè¥¿ä¹‹æ—…</span>
            </p>
        </div>
        
        <div class="flex items-end justify-between w-full pb-2 relative z-10">
            
            <div class="w-1/2 space-y-1">
                <h1 id="header-time" class="text-5xl font-bold leading-tight">--:--</h1>
                
                <div class="group flex items-center w-full">
                    <input id="day-headline" type="text" value="æ¨™é¡Œ" 
                        onblur="saveHeadlineExplicit(this.value)"
                        class="bg-transparent border-none text-2xl tracking-tight font-bold outline-none w-full focus:ring-0 p-0"
                        placeholder="è¼¸å…¥ä¸»é¡Œ">
                </div>

                <div id="header-location-box" class="flex items-center pt-1">
                    <a id="header-map-link" href="#" target="_blank" class="flex items-center space-x-1 bg-white/20 backdrop-blur-md px-3 py-1.5 rounded-full border border-white/30 active:scale-95 transition-transform max-w-full overflow-hidden">
                        <i class="fas fa-location-dot text-accent text-[10px]"></i>
                        <span id="header-location-name" class="text-[11px] font-medium truncate">åœ°æ¨™</span>
                    </a>
                    <button onclick="editHeaderMap()" class="ml-1 text-[10px] opacity-40"><i class="fas fa-edit"></i></button>
                </div>
            </div>

            <div class="w-1/2 rounded-2xl border border-white/20 bg-white/10 p-3 backdrop-blur-md shrink-0 ml-3">
                <div class="flex justify-between items-center mb-1.5">
                    <div class="flex items-center gap-1">
                        <div id="weather-icon-container" class="scale-90 origin-left"></div>
                        <div>
                            <p id="header-temp" class="text-2xl font-bold leading-none">--Â°</p>
                            <p id="feels-like" class="text-[9px] text-white/60">é«”æ„Ÿ --Â°</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p id="rain-chance" class="text-blue-300 font-bold text-[10px]"><i class="fas fa-umbrella mr-0.5"></i>--%</p>
                        <p id="location-city" class="text-[8px] text-white/40 uppercase tracking-widest">OSAKA</p>
                    </div>
                </div>
                
                <div id="hourly-forecast" class="flex gap-2 overflow-x-auto pb-1 scrollbar-hide border-t border-white/10 pt-1.5 text-center">
                    <div class="text-[10px] text-white/30">Loading...</div>
                </div>
            </div>

        </div>
    </header>

    <nav id="date-nav" class="flex overflow-x-auto p-4 space-x-3 no-scrollbar bg-white shadow-sm sticky top-0 z-40"></nav>

    <div class="flex p-4 space-x-2 bg-white/50 border-b border-gray-100">
        <button onclick="changeTotalDays(1)" class="text-xs border border-accent text-accent px-3 py-1 rounded">+ æ–°å¢å¤©æ•¸</button>
        <button onclick="changeTotalDays(-1)" class="text-xs border border-gray-300 text-gray-400 px-3 py-1 rounded">- æ¸›å°‘å¤©æ•¸</button>
        <input type="date" onchange="updateStartDate(this.value)" class="text-xs border border-gray-300 p-1 rounded ml-auto">
    </div>

    <div class="flex justify-around border-b border-gray-100 bg-white text-sm font-medium sticky top-[72px] z-40">
        <button onclick="switchMainTab('itinerary')" class="tab-active px-6 py-3" id="btn-itinerary">è¡Œç¨‹è¡¨</button>
        <button onclick="switchMainTab('accounting')" class="px-6 py-3 text-gray-400" id="btn-accounting">è¨˜å¸³æœ¬</button>
        <button onclick="switchMainTab('shopping')" class="px-6 py-3 text-gray-400" id="btn-shopping">è³¼ç‰©æ¸…å–®</button>
    </div>

    <main class="p-4">
        <section id="section-itinerary" class="main-section timeline-line relative space-y-6 pl-10">
            <div id="drag-container"></div>
            <div class="border-t border-dashed border-gray-300 pt-4">
                <p class="text-[10px] tracking-widest text-gray-400 uppercase">Daily Expense</p>
                <p id="total-expense" class="text-accent mt-1 font-serif text-3xl font-bold">Â¥ 0</p>
            </div>
        </section>

        <section id="section-accounting" class="main-section hidden px-4 pt-4 pb-24 space-y-6">
            <div class="bg-black text-white p-6 rounded-3xl shadow-xl">
                <p class="text-xs text-gray-400 uppercase tracking-widest mb-1">Total Trip Expense</p>
                <h2 id="stats-total" class="text-4xl font-serif font-bold text-[#B59F7A]">Â¥ 0</h2>
                <div class="mt-4 grid grid-cols-2 gap-4 border-t border-gray-800 pt-4">
                    <div>
                        <p class="text-[10px] text-gray-500 uppercase">ğŸ’µ ç¾é‡‘åˆè¨ˆ</p>
                        <p id="stats-cash" class="font-bold text-green-400">Â¥ 0</p>
                    </div>
                    <div>
                        <p class="text-[10px] text-gray-500 uppercase">ğŸ’³ åˆ·å¡åˆè¨ˆ</p>
                        <p id="stats-card" class="font-bold text-blue-400">Â¥ 0</p>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                <h3 class="flex items-center text-gray-800 mb-4">
                    <i class="fas fa-chart-pie mr-2 text-accent text-2xl"></i> 
                    <span class="text-xl font-bold tracking-tight">åˆ†é¡èŠ±è²»åˆ†å¸ƒ</span>
                </h3>
                
                <div class="relative h-48 w-full">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>

            <div class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden">
                <button onclick="toggleExpenseList()" class="w-full px-6 py-4 flex justify-between items-center hover:bg-gray-50 transition-colors">
                    <h3 class="text-sm font-bold flex items-center">
                        <i class="fas fa-list-ul mr-2 text-xl"></i> æ¶ˆè²»æ˜ç´°ç¸½è¦½
                    </h3>
                    <i id="expense-list-arrow" class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                </button>
                
                <div id="full-expense-list-container" class="hidden border-t border-gray-50 max-h-[400px] overflow-y-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-stone-50 text-[12px] text-gray-400 uppercase sticky top-0">
                            <tr>
                                <th class="px-6 py-2">æ—¥æœŸ/é …ç›®</th>
                                <th class="px-6 py-2">æ–¹å¼</th>
                                <th class="px-6 py-2 text-right">é‡‘é¡</th>
                            </tr>
                        </thead>
                        <tbody id="full-expense-list-body">
                            </tbody>
                    </table>
                </div>
            </div>

            <button onclick="toggleCalc()" class="w-full bg-stone-100 text-stone-600 py-4 rounded-2xl font-bold flex items-center justify-center space-x-2 active:scale-95 transition-transform">
                <i class="fas fa-calculator"></i>
                <span>é–‹å•ŸåŒ¯ç‡è¨ˆç®—æ©Ÿ</span>
            </button>
        </section>

        <section id="section-shopping" class="hidden p-4 space-y-6">
            <div class="sticky top-0 z-10 bg-white/80 backdrop-blur-md p-4 rounded-2xl shadow-sm border border-gray-100">
                <p class="text-[10px] text-gray-400 font-bold mb-2 uppercase tracking-widest">Quick Filter å¿«é€Ÿç¯©é¸</p>
                
                <div class="flex flex-col gap-3">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="filterShopping('ALL')" class="px-3 py-1 bg-[#8E2B2B] text-white rounded-full text-xs font-bold">å…¨éƒ¨</button>
                        <button onclick="filterShopping('â¤ï¸â¤ï¸â¤ï¸')" class="px-3 py-1 bg-pink-50 text-pink-500 rounded-full text-xs">ğŸ”¥ å¿…è²·</button>
                    </div>

                    <div class="flex gap-2">
                        <select id="filter-cat" onchange="filterShopping(this.value)" class="flex-1 p-2 bg-gray-100 rounded-xl text-xs border-none ring-1 ring-gray-200">
                            <option value="ALL">ğŸ” æ‰€æœ‰å­åˆ†é¡</option>
                        </select>
                        <select id="filter-loc" onchange="filterShopping(this.value)" class="flex-1 p-2 bg-gray-100 rounded-xl text-xs border-none ring-1 ring-gray-200">
                            <option value="ALL">ğŸ“ æ‰€æœ‰åœ°é»</option>
                            <option value="ç¥æˆ¶">ç¥æˆ¶</option>
                            <option value="å¤§é˜ª">å¤§é˜ª</option>
                            <option value="äº¬éƒ½">äº¬éƒ½</option>
                            <option value="å¤©æ©‹ç«‹">å¤©æ©‹ç«‹</option>
                            <option value="ä¼Šæ ¹èˆŸå±‹">ä¼Šæ ¹èˆŸå±‹</option>
                            <option value="åŸå´æº«æ³‰">åŸå´æº«æ³‰</option>
                        </select>
                    </div>
                </div>
            </div>

            <h3 class="text-lg font-bold mb-4 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <span>ğŸ‘¤ è‚²è–°</span>
                    <button onclick="toggleUserList('User A')" class="text-gray-400 hover:text-accent transition-colors">
                        <i id="eye-User A" class="fas fa-eye"></i>
                    </button>
                </div>
                <button onclick="openShopModal('User A')" class="text-accent"><i class="fas fa-plus-circle"></i></button>
            </h3>
            <div id="shop-list-A" class="space-y-3"></div>

            <h3 class="text-lg font-bold mb-4 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <span>ğŸ‘¤ ç¾å¦®</span>
                    <button onclick="toggleUserList('User B')" class="text-gray-400 hover:text-accent">
                        <i id="eye-User B" class="fas fa-eye"></i>
                    </button>
                </div>
                <button onclick="openShopModal('User B')" class="text-accent"><i class="fas fa-plus-circle"></i></button>
            </h3>
            <div id="shop-list-B" class="space-y-3"></div>

            <h3 class="text-lg font-bold mb-4 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <span>ğŸ‘¤ ç¾å„€</span>
                    <button onclick="toggleUserList('User C')" class="text-gray-400 hover:text-accent">
                        <i id="eye-User C" class="fas fa-eye"></i>
                    </button>
                </div>
                <button onclick="openShopModal('User C')" class="text-accent"><i class="fas fa-plus-circle"></i></button>
            </h3>
            <div id="shop-list-C" class="space-y-3"></div>
        </section>

        
    </main>

    <div class="fixed right-6 bottom-6 z-50">
        <button onclick="openAddModal()" class="bg-accent flex h-14 w-14 items-center justify-center rounded-full text-2xl text-gray-400 shadow-2xl transition-transform active:scale-90">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <div class="p-4 flex gap-2">
        <button onclick="exportData()" class="bg-blue-500 text-white px-4 py-2 rounded">åŒ¯å‡ºå‚™ä»½æª”</button>
        <button onclick="importData()" class="bg-green-500 text-white px-4 py-2 rounded">åŒ¯å…¥å‚™ä»½æª”</button>
    </div>

    

    <div id="edit-modal" class="fixed inset-0 z-[100] hidden items-end justify-center bg-black/60 backdrop-blur-sm sm:items-center">
        <div class="w-full max-w-lg rounded-t-3xl bg-white p-6 sm:rounded-3xl">
            <div class="mb-6 flex items-center justify-between">
                <h2 class="border-accent border-l-4 pl-2 text-xl font-bold">è¡Œç¨‹ç·¨è¼¯</h2>
                <button onclick="closeModal()" class="text-gray-400"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form class="space-y-4" onsubmit="event.preventDefault();">
                <div class="flex space-x-4">
                    <div class="flex-1">
                        <label class="block text-[10px] text-gray-400 uppercase">æ™‚é–“</label>
                        <input id="modal-time" type="time" class="w-full border-b border-gray-200 py-2 text-lg outline-none">
                    </div>
                    <div class="flex-1">
                        <label class="block text-[10px] text-gray-400 uppercase">åˆ†é¡</label>
                        <select id="modal-type" class="w-full border-b border-gray-200 py-2 outline-none">
                            <option>åˆé¤</option><option>æ™šé¤</option><option>æ™¯é»</option><option>äº¤é€š</option><option>è³¼ç‰©é€›è¡—</option><option>è¶…å¸‚</option><option>æº«æ³‰</option><option>æ—…é¤¨</option><option>å½ˆæ€§</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] text-gray-400 uppercase">æ¨™é¡Œ</label>
                    <input type="text" id="modal-title" class="w-full border-b border-gray-200 py-2 text-lg outline-none font-bold" placeholder="è¼¸å…¥åç¨±">
                </div>
                <div>
                    <label class="block text-[10px] text-gray-400 uppercase">åœ°åœ–é€£çµ</label>
                    <input type="text" id="modal-map" class="w-full border-b border-gray-200 py-2 text-sm outline-none" placeholder="Google Maps URL">
                </div>
                <div>
                    <label class="block text-[10px] text-gray-400 uppercase">å‚™è¨»</label>
                    <textarea id="modal-note" rows="3" class="w-full bg-stone-50 rounded-xl p-3 text-sm mt-1 outline-none"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4 pt-4">
                    <button type="button" onclick="deleteEvent()" class="border border-gray-300 py-4 rounded-xl text-gray-500 font-bold">åˆªé™¤</button>
                    <button type="button" onclick="updateEvent()" class="bg-black text-white py-4 rounded-xl font-bold shadow-lg">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <div id="expense-modal" class="fixed inset-0 z-[110] hidden items-end justify-center bg-black/60 backdrop-blur-sm sm:items-center">
        <div class="w-full max-w-lg rounded-t-3xl bg-white p-6 sm:rounded-3xl">
            <div class="mb-4 flex items-center justify-between">
                <h2 class="border-accent border-l-4 pl-2 text-xl font-bold">æ¶ˆè²»æ˜ç´°</h2>
                <button onclick="closeExpenseModal()" class="text-gray-400"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="expense-list" class="space-y-3 max-h-[30vh] overflow-y-auto no-scrollbar mb-4"></div>
            <div class="bg-stone-50 p-4 rounded-xl space-y-3 border border-gray-100">
                <input id="new-exp-name" type="text" placeholder="é …ç›®åç¨±" class="w-full bg-white border border-gray-200 rounded-lg p-3 text-sm outline-none focus:border-accent">
                <div class="grid grid-cols-3 gap-2">
                    <select id="new-exp-type" class="bg-white border border-gray-200 rounded-lg p-2 text-xs outline-none">
                        <option>é£²é£Ÿ</option><option>äº¤é€šé–€ç¥¨</option><option>è³¼ç‰©</option><option>ä½å®¿</option>
                    </select>
                    <select id="new-exp-method" class="bg-white border border-gray-200 rounded-lg p-2 text-xs outline-none text-accent font-bold">
                        <option value="ç¾é‡‘">ğŸ’µ ç¾é‡‘</option><option value="ä¿¡ç”¨å¡">ğŸ’³ åˆ·å¡</option>
                    </select>
                    <input id="new-exp-amount" type="number" placeholder="Â¥" class="bg-white border border-gray-200 rounded-lg p-2 text-xs outline-none">
                </div>
                <button onclick="addExpenseItem()" class="w-full bg-accent text-gray-500 py-3 rounded-xl text-sm font-bold shadow-md active:scale-95 transition-transform">+ æ–°å¢é …ç›®</button>
            </div>
            <div class="mt-4 flex justify-between items-center px-2">
                <span class="text-gray-500 text-xs font-bold uppercase">Total JPY</span>
                <span id="expense-total" class="text-accent text-3xl font-serif font-bold">Â¥ 0</span>
            </div>
        </div>
    </div>

    <div id="calc-modal" class="fixed inset-0 z-[200] hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-[#1C1C1E] w-full max-w-xs rounded-[2.5rem] shadow-2xl overflow-hidden border border-white/10">
            <div class="p-6 text-right space-y-1">
                <div class="flex justify-between items-center mb-2">
                    <span id="rate-tag" class="text-[10px] bg-accent/20 text-accent px-2 py-0.5 rounded text-white/50">å¯¦æ™‚åŒ¯ç‡: --</span>
                    <label class="flex items-center cursor-pointer">
                        <span class="text-[10px] text-white/50 mr-2">è‡ªå‹•æ›ç®—å°å¹£</span>
                        <input type="checkbox" id="auto-convert" class="sr-only peer" checked>
                        <div class="w-7 h-4 bg-gray-600 rounded-full peer peer-checked:bg-accent after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:after:translate-x-3 relative"></div>
                    </label>
                </div>
                <div id="calc-display" class="text-4xl font-light text-white overflow-hidden whitespace-nowrap">0</div>
                <div id="calc-converted" class="text-lg font-medium text-gray-400 h-7">â‰ˆ TWD 0</div>
            </div>
        
            <div class="grid grid-cols-4 gap-3 p-6 pt-2 bg-black/20">
                <button onclick="pressCalc('C')" class="aspect-square rounded-full bg-[#A5A5A5] text-black text-xl font-bold">C</button>
                <button onclick="pressOp('/',this)" class="aspect-square rounded-full bg-accent text-white text-xl font-bold">Ã·</button>
                <button onclick="pressOp('*',this)" class="aspect-square rounded-full bg-accent text-white text-xl font-bold">Ã—</button>
                <button onclick="pressDelete()" class="aspect-square rounded-full bg-[#333333] text-white text-xl"><i class="fas fa-backspace"></i></button>
                
                <button onclick="pressNum('7')" class="aspect-square rounded-full bg-[#333333] text-white text-2xl">7</button>
                <button onclick="pressNum('8')" class="aspect-square rounded-full bg-[#333333] text-white text-2xl">8</button>
                <button onclick="pressNum('9')" class="aspect-square rounded-full bg-[#333333] text-white text-2xl">9</button>
                <button onclick="pressOp('-',this)" class="aspect-square rounded-full bg-accent text-white text-xl font-bold">-</button>
                
                <button onclick="pressNum('4')" class="aspect-square rounded-full bg-[#333333] text-white text-2xl">4</button>
                <button onclick="pressNum('5')" class="aspect-square rounded-full bg-[#333333] text-white text-2xl">5</button>
                <button onclick="pressNum('6')" class="aspect-square rounded-full bg-[#333333] text-white text-2xl">6</button>
                <button onclick="pressOp('+',this)" class="aspect-square rounded-full bg-accent text-white text-xl font-bold">+</button>
                
                <button onclick="pressNum('1')" class="aspect-square rounded-full bg-[#333333] text-white text-2xl">1</button>
                <button onclick="pressNum('2')" class="aspect-square rounded-full bg-[#333333] text-white text-2xl">2</button>
                <button onclick="pressNum('3')" class="aspect-square rounded-full bg-[#333333] text-white text-2xl">3</button>
                <button id="btn-equals" onclick="calculateResult()" class="row-span-2 aspect-[1/2.2] rounded-full bg-accent text-white text-2xl font-bold">=</button>
                
                <button onclick="pressNum('0')" class="col-span-2 h-14 rounded-full bg-[#333333] text-white text-2xl text-left pl-8">0</button>
                <button onclick="pressNum('.')" class="aspect-square rounded-full bg-[#333333] text-white text-2xl">.</button>
            </div>
            
            <button onclick="toggleCalc()" class="w-full py-4 text-white/30 text-xs hover:text-white uppercase tracking-widest">Close Calculator</button>
        </div>
    </div>

    <div id="shop-modal" class="fixed inset-0 z-[150] hidden bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl">
            <h2 id="modal-title" class="text-xl font-bold mb-4">æ–°å¢æ¸…å–®é …ç›®</h2>
            
            <input type="hidden" id="edit-item-id">

            <div class="space-y-4">
                <input id="shop-item-name" type="text" placeholder="æƒ³è²·ä»€éº¼ï¼Ÿ" class="w-full p-3 bg-gray-50 rounded-xl">
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest flex justify-between">
                        ç…§ç‰‡ç¶²å€ (å¯å¤šç­†)
                        <button onclick="addPhotoInput('')" class="text-accent hover:underline">+ æ–°å¢ç¶²å€</button>
                    </label>
                    <div id="photo-input-container" class="space-y-2">
                        </div>
                </div>  

                <div class="grid grid-cols-2 gap-3">
                    <select id="shop-attr" class="p-2 bg-gray-50 rounded-lg"><option>é£Ÿ</option><option>è¡£</option><option>ä½</option><option>è¡Œ</option><option>è‚²</option><option>æ¨‚</option></select>
                    <input id="shop-cat" type="text" placeholder="å­åˆ†é¡" class="p-2 bg-gray-50 rounded-lg">
                </div>

                <div class="grid grid-cols-2 gap-4 items-end"> <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">åœ°é»</label>
                        <select id="shop-loc" class="w-full h-[52px] px-4 bg-gray-50 rounded-2xl text-sm border-none ring-1 ring-gray-100 focus:ring-accent transition-all">
                            <option>ç¥æˆ¶</option>
                            <option>å¤§é˜ª</option>
                            <option>äº¬éƒ½</option>
                            <option>å¤©æ©‹ç«‹</option>
                            <option>ä¼Šæ ¹èˆŸå±‹</option>
                            <option>åŸå´æº«æ³‰</option>
                        </select>
                    </div>

                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">æƒ³è¦ç¨‹åº¦</label>
                        <div class="flex items-center justify-between h-[52px] px-3 bg-pink-50/30 rounded-2xl border border-pink-100/50 overflow-hidden">
                            <div class="flex gap-2">
                                <span onclick="setHeart(1)" class="heart-emoji-btn text-2xl leading-none" data-index="1">ğŸ¤</span>
                                <span onclick="setHeart(2)" class="heart-emoji-btn text-2xl leading-none" data-index="2">ğŸ¤</span>
                                <span onclick="setHeart(3)" class="heart-emoji-btn text-2xl leading-none" data-index="3">ğŸ¤</span>
                            </div>
                            <div id="heart-tag" class="shrink-0 px-2 py-1 bg-white rounded-full text-[10px] font-extrabold text-pink-300 shadow-sm border border-pink-100">
                                å¿ƒå‹•
                            </div>
                        </div>
                        <input type="hidden" id="shop-heart" value="0">
                    </div>
                </div>

                <div class="flex gap-2 pt-4">
                    <button onclick="closeShopModal()" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold">å–æ¶ˆ</button>
                    <button id="modal-submit-btn" onclick="saveShopItem()" style="background-color: #8E2B2B;" class="flex-1 py-3 text-white rounded-xl font-bold">ç¢ºèª</button>
                </div>
            </div>
        </div>
    </div>

    <div id="image-lightbox" onclick="closeLightbox()" class="fixed inset-0 z-[300] hidden bg-black/90 flex items-center justify-center p-4 cursor-zoom-out">
        <img id="lightbox-img" src="" class="max-w-full max-h-full rounded-lg shadow-2xl transform transition-transform duration-300">
        <p class="absolute bottom-8 text-white/50 text-xs tracking-widest uppercase">é»æ“Šä»»ä½•åœ°æ–¹é—œé–‰</p>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDIaQM6Cgde70BuHDKFbdCDgKe0zBI11tc",
            authDomain: "winter-trip-a559d.firebaseapp.com",
            databaseURL: "https://winter-trip-a559d-default-rtdb.firebaseio.com",
            projectId: "winter-trip-a559d",
            storageBucket: "winter-trip-a559d.firebasestorage.app",
            messagingSenderId: "833989633940",
            appId: "1:833989633940:web:301a17973b5ef49b1a5181",
            measurementId: "G-17LRCRJH8Y"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        db.ref('travelData').on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                travelData = data;
                renderDateNav();
                renderEvents();
                updateHeaderInfo();
            }
        });

        db.ref('shoppingData').on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                shoppingData = data;
                // æª¢æŸ¥åˆ†é ç‹€æ…‹å†ç•«åœ–ï¼Œé¿å…ä½ çš„é¡¯ç¤ºå•é¡Œ
                const shopSection = document.getElementById('section-shopping');
                if (shopSection && !shopSection.classList.contains('hidden')) {
                    renderShopping();
                }
            }
        });
        // --- åŸºç¤è³‡æ–™ ---
        let travelData = {
            startDate: localStorage.getItem('startDate') || "2026-02-10",
            totalDays: parseInt(localStorage.getItem('totalDays')) || 10,
            currentDay: 0,
            events: JSON.parse(localStorage.getItem('myTravelEvents')) || []
        };

        let myChart = null;
        let currentRate = 0.215;
        let currentEditingEventId = null;
        let shoppingVisibility = {
            'User A': true,
            'User B': true,
            'User C': true
        };
        // --- åˆå§‹åŒ–èˆ‡å°è¦½ ---
        function renderDateNav() {
            const nav = document.getElementById('date-nav');
            nav.innerHTML = '';
            
            // å®šç¾©æ˜ŸæœŸçš„ä¸­æ–‡é™£åˆ—
            const weekDays = ["é€±æ—¥", "é€±ä¸€", "é€±äºŒ", "é€±ä¸‰", "é€±å››", "é€±äº”", "é€±å…­"];

            for (let i = 0; i < travelData.totalDays; i++) {
                let d = new Date(travelData.startDate);
                d.setDate(d.getDate() + i);
                
                // ğŸŒŸ ç²å–æ˜ŸæœŸå¹¾
                const weekDayStr = weekDays[d.getDay()];
                
                let displayDate = (d.getMonth() + 1) + "/" + d.getDate();
                const isActive = (i === travelData.currentDay);
                const activeClass = isActive ? 'bg-[#8E2B2B] text-white border-[#8E2B2B]' : 'bg-white text-gray-400 border-gray-200';
                
                nav.innerHTML += `
                    <div onclick="selectDay(${i})" class="min-w-[70px] h-20 border-2 ${activeClass} rounded-xl flex flex-col items-center justify-center cursor-pointer transition-all shadow-sm">
                        <span class="text-[10px] mb-0.5">${weekDayStr}</span>
                        
                        <span class="font-bold text-lg leading-none">${displayDate}</span>
                        
                        <span class="text-[9px] mt-1 opacity-70">Day ${i + 1}</span>
                    </div>`;
            }
        }
        // --- æ¨™é¡Œè¼¸å…¥
        function saveHeadlineExplicit(val) {
            localStorage.setItem(`headline-day-${travelData.currentDay}`, val);
        }

        function selectDay(newIndex) {
            try {
                // 1. å®‰å…¨æŠ“å–ç›®å‰çš„æ¨™é¡Œå…§å®¹
                const headlineEl = document.getElementById('day-headline');
                if (headlineEl) {
                    // åœ¨åˆ‡æ›å¤©æ•¸å‰ï¼ŒæŠŠç›®å‰çœ‹åˆ°çš„æ–‡å­—å­˜å…¥ã€ŒèˆŠçš„ã€ç´¢å¼•
                    localStorage.setItem(`headline-day-${travelData.currentDay}`, headlineEl.value);
                }

                travelData.currentDay = newIndex;
                renderDateNav();
                renderEvents();
                updateHeaderInfo(); // é€™è£¡æœƒæŠŠæ–°æ—¥æœŸçš„è³‡æ–™å¡«å› input
                updateDetailedWeather();

            } catch (e) {
                console.error("åˆ‡æ›æ—¥æœŸå‡ºéŒ¯:", e);
                // å¦‚æœä¸Šé¢å­˜æª”å‡ºéŒ¯ï¼Œè‡³å°‘è®“åˆ‡æ›åŠŸèƒ½ç¹¼çºŒè·‘
                travelData.currentDay = newIndex;
                renderDateNav();
                renderEvents();
            }
        }
        // --- å¤©æ°£ ---
        const WEATHER_API_KEY = "ed260d74a9ef55165d1397592ff7db1e";

        async function updateDetailedWeather() {
            const tempEl = document.getElementById('header-temp');
            if (!tempEl) return;

            const day = travelData.currentDay;
            const locName = localStorage.getItem(`loc-name-${day}`) || "Osaka";
            let searchCity = "Osaka"; // é è¨­å€¼
            if (locName.includes("äº¬éƒ½")) searchCity = "Kyoto";
            else if (locName.includes("æ±äº¬")) searchCity = "Tokyo";
            else if (locName.includes("ç¥æˆ¶")) searchCity = "Kobe";
            else if (locName.includes("åŸå´")) searchCity = "Toyooka"; // åŸå´æº«æ³‰é è¿‘è±å²¡å¸‚
            else if (locName.includes("ä¼Šæ ¹") || locName.includes("å¤©æ©‹ç«‹")) searchCity = "Miyazu"; // å®®æ´¥å¸‚

            if (cityLabel) cityLabel.innerText = searchCity.toUpperCase();

            try {
                const url = `https://api.openweathermap.org/data/2.5/forecast?q=${searchCity}&units=metric&appid=${WEATHER_API_KEY}`;
                const res = await fetch(url);
                const data = await res.json();

                if (data.cod === "200") {
                    // æ›´æ–°ä¸»æº«åº¦èˆ‡é«”æ„Ÿ
                    tempEl.innerText = `${Math.round(data.list[0].main.temp)}Â°`;
                    document.getElementById('feels-like').innerText = `é«”æ„Ÿ ${Math.round(data.list[0].main.feels_like)}Â°`;
                    
                    // æ›´æ–°ä¸»å¤©æ°£åœ–ç¤º
                    updateMainWeatherIcon(data.list[0].weather[0].main);

                    // æ›´æ–°é™é›¨æ©Ÿç‡ (OpenWeatherMap çš„ 5å¤©é å ±ä¸­æœ‰ pop æ¬„ä½)
                    const rainChance = (data.list[0].pop * 100).toFixed(0);
                    document.getElementById('rain-chance').innerHTML = `<i class="fas fa-umbrella mr-1"></i>${rainChance}%`;

                    // æ¸²æŸ“æ¯å°æ™‚é å ± (ç¸®å°å¯¬åº¦ï¼Œè®“å®ƒæ›´å¥½çœ‹)
                    const hourlyContainer = document.getElementById('hourly-forecast');
                    if (hourlyContainer) {
                        hourlyContainer.innerHTML = data.list.slice(0, 6).map(item => `
                            <div class="flex flex-col items-center min-w-[40px]">
                                <p class="text-[9px] opacity-40">${new Date(item.dt * 1000).getHours()}h</p>
                                <i class="${getWeatherIconClass(item.weather[0].main)} text-xs my-1 text-white/80"></i>
                                <p class="text-[11px] font-bold">${Math.round(item.main.temp)}Â°</p>
                            </div>
                        `).join('');
                    }
                }
            } catch (e) {
                tempEl.innerText = "--Â°";
                console.error("å¤©æ°£è®€å–å¤±æ•—");
            }
        }

        // è¼”åŠ©å‡½æ•¸ï¼šæ ¹æ“šå¤©æ°£ç‹€æ…‹è¿”å›å°æ‡‰çš„ FontAwesome Class
        function getWeatherIconClass(status) {
            if (status === "Clear") return "fas fa-sun text-yellow-300";
            if (status === "Clouds") return "fas fa-cloud text-gray-300";
            if (status === "Rain") return "fas fa-cloud-showers-heavy text-blue-400";
            if (status === "Snow") return "fas fa-snowflake text-blue-100";
            return "fas fa-cloud-sun text-stone-300";
        }

        function updateMainWeatherIcon(status) {
            const container = document.getElementById('weather-icon-container');
            container.innerHTML = `<i class="${getWeatherIconClass(status)} text-3xl"></i>`;
        }
        function switchMainTab(tabName) {
            const sections = document.querySelectorAll('.main-section');
            sections.forEach(s => s.classList.add('hidden'));

            const targetSection = document.getElementById(`section-${tabName}`);
            if (targetSection) targetSection.classList.remove('hidden');

            document.querySelectorAll('#btn-itinerary, #btn-accounting, #btn-shopping').forEach(b => {
                b.classList.remove('tab-active', 'text-accent'); b.classList.add('text-gray-400');
            });
            const activeBtn = document.getElementById(`btn-${tabName}`);
            if(activeBtn) { activeBtn.classList.add('tab-active'); activeBtn.classList.remove('text-gray-400'); }

            if (tabName === 'shopping') renderShopping();
            else if (tabName === 'itinerary') renderEvents();
            else if (tabName === 'accounting') renderAccountingStats();
        }
        // --- Header å°ˆå±¬åŠŸèƒ½ ---

        // 1. å„²å­˜æ¯æ—¥å¤§æ¨™ (å„²å­˜åˆ° localStorageï¼ŒæŒ‰æ—¥æœŸåˆ†é–‹)
        function saveHeadline(val) {
            const day = travelData.currentDay; 
            localStorage.setItem(`headline-day-${day}`, val);
            console.log(`å·²å„²å­˜ Day ${day} çš„æ¨™é¡Œ: ${val}`);
        }

        // 2. ç·¨è¼¯ä»Šæ—¥åœ°æ¨™é€£çµ
        function editHeaderMap() {
            const day = travelData.currentDay;
            const currentName = document.getElementById('header-location-name').innerText;
            const name = prompt("è«‹è¼¸å…¥åœ°æ¨™åç¨± (å¦‚: å¤§é˜ªç’°çƒå½±åŸ):", currentName);
            const url = prompt("è«‹è²¼ä¸Š Google Maps ç¶²å€:");
            
            if (name) {
                document.getElementById('header-location-name').innerText = name;
                localStorage.setItem(`loc-name-${travelData.currentDay}`, name);
                updateDetailedWeather();
            }
            if (url) {
                document.getElementById('header-map-link').href = url;
                localStorage.setItem(`loc-url-${travelData.currentDay}`, url);
            }
        }

        // 3. åœ¨åˆ‡æ›æ—¥æœŸæˆ–è¼‰å…¥æ™‚ï¼Œæ›´æ–° Header è³‡è¨Š
        function updateHeaderInfo() {
            const day = travelData.currentDay;
            
            // è®€å–æ¨™é¡Œ
            const savedHeadline = localStorage.getItem(`headline-day-${day}`) || "æ¨™é¡Œ";
            document.getElementById('day-headline').value = savedHeadline;
            
            // è®€å–åœ°é»
            const savedLocName = localStorage.getItem(`loc-name-${day}`) || "è¨­å®šä»Šæ—¥ä¸»è¦åœ°æ¨™";
            const savedLocUrl = localStorage.getItem(`loc-url-${day}`) || "#";
            document.getElementById('header-location-name').innerText = savedLocName;
            document.getElementById('header-map-link').href = savedLocUrl;
        }

        // 4. ç•¶åœ°æ™‚é–“æ¯ç§’æ›´æ–°
        function startClock() {
            setInterval(() => {
                const now = new Date();
                const options = { timeZone: "Asia/Tokyo", hour: '2-digit', minute: '2-digit', hour12: false };
                const timeStr = new Intl.DateTimeFormat('zh-TW', options).format(now);
                const el = document.getElementById('header-time');
                if(el) el.innerText = timeStr;
            }, 1000);
        }

        // --- è¡Œç¨‹æ¸²æŸ“ ---
        function renderEvents() {
            const list = document.getElementById('drag-container');
            list.innerHTML = '';
            const todayEvents = travelData.events.filter(e => e.day === travelData.currentDay);
            todayEvents.sort((a, b) => a.time.localeCompare(b.time));

            const typeColors = {
                'åˆé¤': 'bg-orange-500', 'æ™šé¤': 'bg-green-600', 'æ™¯é»': 'bg-emerald-600',
                'äº¤é€š': 'bg-blue-800', 'è³¼ç‰©é€›è¡—': 'bg-pink-500', 'è¶…å¸‚': 'bg-red-500',
                'æº«æ³‰': 'bg-indigo-500', 'æ—…é¤¨': 'bg-stone-700', 'å½ˆæ€§': 'bg-gray-400'
            };
            let dayTotal = 0;

            todayEvents.forEach(event => {
                const bgColor = typeColors[event.type] || 'bg-gray-400';
                const eventExpTotal = (event.expenses || []).reduce((sum, exp) => sum + Number(exp.amount), 0);
                dayTotal += eventExpTotal;

                list.innerHTML += `
                <div class="flex items-stretch mb-6 group">
                    <div class="relative flex-1 bg-white p-4 rounded-l-xl shadow-sm border-l-4 border-[#8E2B2B]" onclick="openEditModal(${event.id})">
                        <div class="absolute -left-[31px] top-4 w-5 h-5 bg-accent rounded-full border-4 border-[#F9F7F2]"></div>
                        
                        <div class="flex items-center space-x-4 mb-1">
                            <span class="text-lg font-bold">${event.time}</span>
                            <span class="${bgColor} px-2.5 py-1 rounded text-[13px] text-white font-bold">${event.type}</span>
                        </div>

                        <div class="flex items-start gap-2">
                            <h3 class="text-base font-bold text-gray-700 break-words flex-1 leading-snug">
                                ${event.title}
                            </h3>
                            
                            ${event.mapUrl ? `
                                <a href="${event.mapUrl}" target="_blank" onclick="event.stopPropagation();" class="text-blue-500 pt-0.5">
                                    <i class="fas fa-location-arrow text-sm"></i>
                                </a>
                            ` : ''}
                        </div>

                        ${event.note ? `<p class="text-xs text-gray-400 mt-1 break-words">${event.note}</p>` : ''}
                    </div>

                    <div class="w-24 bg-stone-100 rounded-r-xl border-l border-dashed border-gray-200 flex flex-col items-center justify-center cursor-pointer active:bg-gray-200" 
                        onclick="event.stopPropagation(); openExpenseModal(${event.id});">
                        <span class="text-[9px] text-gray-400 font-bold uppercase">Expense</span>
                        <span class="text-accent font-serif font-bold">Â¥ ${eventExpTotal.toLocaleString()}</span>
                    </div>
                </div>`;
            });
            document.getElementById('total-expense').innerText = `Â¥ ${dayTotal.toLocaleString()}`;
        }

        // --- è¡Œç¨‹ç·¨è¼¯ ---
        function openAddModal() {
            const modal = document.getElementById('edit-modal');
            document.getElementById('modal-title').value = "";
            document.getElementById('modal-time').value = "12:00";
            document.getElementById('modal-type').value = "æ™¯é»";
            document.getElementById('modal-map').value = "";
            document.getElementById('modal-note').value = "";
            delete modal.dataset.editingId;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function openEditModal(eventId) {
            const event = travelData.events.find(e => e.id === eventId);
            const modal = document.getElementById('edit-modal');
            document.getElementById('modal-title').value = event.title;
            document.getElementById('modal-time').value = event.time;
            document.getElementById('modal-type').value = event.type;
            document.getElementById('modal-map').value = event.map || "";
            document.getElementById('modal-note').value = event.note || "";
            modal.dataset.editingId = eventId;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function updateEvent() {
            const modal = document.getElementById('edit-modal');
            const editingId = modal.dataset.editingId;
            const title = document.getElementById('modal-title').value;
            const time = document.getElementById('modal-time').value;
            const type = document.getElementById('modal-type').value;
            if (!title) return alert("è«‹è¼¸å…¥æ¨™é¡Œ");

            if (editingId) {
                const event = travelData.events.find(e => e.id === Number(editingId));
                event.title = title; event.time = time; event.type = type;
                event.map = document.getElementById('modal-map').value;
                event.note = document.getElementById('modal-note').value;
            } else {
                travelData.events.push({ id: Date.now(), day: travelData.currentDay, title, time, type, map: document.getElementById('modal-map').value, note: document.getElementById('modal-note').value, expenses: [] });
            }
            saveData();
            closeModal();
            renderEvents();
        }

        function deleteEvent() {
            const id = document.getElementById('edit-modal').dataset.editingId;
            if (id && confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) {
                travelData.events = travelData.events.filter(e => e.id !== Number(id));
                saveData();
                closeModal();
                renderEvents();
            }
        }

        function closeModal() { document.getElementById('edit-modal').classList.replace('flex', 'hidden'); }

        // --- æ¶ˆè²»æ˜ç´° ---
        function openExpenseModal(eventId) {
            currentEditingEventId = eventId;
            const event = travelData.events.find(e => e.id === eventId);
            document.getElementById('expense-modal').classList.replace('hidden', 'flex');
            renderExpenseList(event);
        }

        function renderExpenseList(event) {
            const list = document.getElementById('expense-list');
            list.innerHTML = '';
            let total = 0;
            const expenses = event.expenses || [];
            expenses.forEach((exp, index) => {
                total += exp.amount;
                const methodTag = exp.method === 'ä¿¡ç”¨å¡' ? 'ğŸ’³ åˆ·å¡' : 'ğŸ’µ ç¾é‡‘';
                list.innerHTML += `
                    <div class="flex justify-between items-center bg-white border p-3 rounded-lg shadow-sm">
                        <div>
                            <span class="text-[9px] bg-stone-100 px-1.5 py-0.5 rounded text-gray-500">${exp.type} | ${methodTag}</span>
                            <div class="font-bold">${exp.name}</div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="font-bold">Â¥ ${exp.amount.toLocaleString()}</span>
                            <button onclick="deleteExpenseItem(${index})" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>`;
            });
            document.getElementById('expense-total').innerText = `Â¥ ${total.toLocaleString()}`;
        }

        function addExpenseItem() {
            const name = document.getElementById('new-exp-name').value;
            const type = document.getElementById('new-exp-type').value;
            const amount = document.getElementById('new-exp-amount').value;
            const method = document.getElementById('new-exp-method').value;

            if (!name || !amount) return alert("è«‹è¼¸å…¥é …ç›®åç¨±èˆ‡é‡‘é¡");

            // ğŸŒŸ ä¿®æ­£é»ï¼šç¢ºä¿å¾ã€Œå…¨åŸŸè³‡æ–™ã€ä¸­ç²¾æº–æ‰¾åˆ°è©² ID çš„è¡Œç¨‹
            const event = travelData.events.find(e => e.id === Number(currentEditingEventId));
            
            if (!event) {
                alert("æ‰¾ä¸åˆ°å°æ‡‰è¡Œç¨‹ï¼Œè«‹å˜—è©¦é‡æ–°é–‹å•Ÿæ˜ç´°è¦–çª—");
                return;
            }

            if (!event.expenses) event.expenses = [];

            // æ–°å¢é …ç›®
            event.expenses.push({ 
                name: name, 
                type: type, 
                amount: Number(amount),
                method: method
            });

            // æ¸…ç©ºè¼¸å…¥æ¡†
            document.getElementById('new-exp-name').value = '';
            document.getElementById('new-exp-amount').value = '';

            // å„²å­˜ä¸¦åˆ·æ–°
            saveAndSync(); 
            renderExpenseList(event); // é‡æ–°ç•«å‡ºè©²å½ˆçª—å…§çš„æ¸…å–®
        }

        function saveAndSync() {
            localStorage.setItem('myTravelEvents', JSON.stringify(travelData.events));
            renderEvents(); // æ›´æ–°ä¸»ç•«é¢å¤©æ•¸ç¸½é¡
            if (!document.getElementById('full-expense-list-container').classList.contains('hidden')) {
                renderFullExpenseList();
            }
        }

        function deleteExpenseItem(index) {
            const event = travelData.events.find(e => e.id === currentEditingEventId);
            event.expenses.splice(index, 1);
            saveData();
            renderExpenseList(event);
            renderEvents();
        }

        function closeExpenseModal() { document.getElementById('expense-modal').classList.replace('flex', 'hidden'); }

        // --- çµ±è¨ˆèˆ‡è¨ˆç®—æ©Ÿ ---
        async function updateLiveRate() {
            try {
                const response = await fetch('https://open.er-api.com/v6/latest/JPY');
                const data = await response.json();
                if (data && data.rates && data.rates.TWD) {
                    currentRate = data.rates.TWD;
                    const rateTag = document.getElementById('rate-tag');
                    if (rateTag) {
                        rateTag.innerText = `å¯¦æ™‚åŒ¯ç‡: ${currentRate.toFixed(4)}`;
                    }
                }
            } catch (error) {
                console.warn("åŒ¯ç‡æ›´æ–°å¤±æ•—ï¼Œä½¿ç”¨ä¿åº•å€¼ 0.215");
                currentRate = 0.215; 
            }
        }

        function renderAccountingStats() {
            let total = 0, cash = 0, card = 0;
            const categoryMap = { 'é£²é£Ÿ': 0, 'äº¤é€šé–€ç¥¨': 0, 'è³¼ç‰©': 0, 'ä½å®¿': 0 };
            travelData.events.forEach(e => {
                (e.expenses || []).forEach(ex => {
                    total += ex.amount;
                    if (ex.method === 'ä¿¡ç”¨å¡') card += ex.amount; else cash += ex.amount;
                    if (categoryMap[ex.type] !== undefined) categoryMap[ex.type] += ex.amount;
                });
            });

            document.getElementById('stats-total').innerText = `Â¥ ${total.toLocaleString()}`;
            document.getElementById('stats-cash').innerText = `Â¥ ${cash.toLocaleString()}`;
            document.getElementById('stats-card').innerText = `Â¥ ${card.toLocaleString()}`;

            const ctx = document.getElementById('categoryChart').getContext('2d');
            if (myChart) myChart.destroy();
            const labels = Object.keys(categoryMap).filter(k => categoryMap[k] > 0);
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{ 
                        data: labels.map(k => categoryMap[k]), 
                        backgroundColor: ['#E63946', '#457B9D', '#A8DADC', '#B59F7A'],
                        borderWidth: 0 
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        // ğŸŒŸ èª¿æ•´åœ–ä¾‹ï¼ˆä¸Šæ–¹æˆ–å´é‚Šçš„æ–‡å­—ï¼‰
                        legend: {
                            position: 'left', align: 'center', // æ”¹åˆ°ä¸‹é¢æ¯”è¼ƒä¸æ“ 
                            labels: {
                                padding: 20,
                                font: {
                                    size: 14, // ğŸ‘ˆ é€™è£¡æ”¹å¤§å­—é«”å¤§å°
                                    family: "'Noto Serif TC', serif", // ä¿æŒèˆ‡ç¶²é å­—é«”ä¸€è‡´
                                    weight: 'bold'
                                },
                                color: '#2D2D2D' // è®“å­—é«”é¡è‰²æ›´æ·±ä¸€é»
                            }
                        },
                        // ğŸŒŸ èª¿æ•´é»æ“Šæˆ–æ»‘éæ™‚çš„æç¤ºæ¡†æ–‡å­—
                        tooltip: {
                            titleFont: { size: 16 },
                            bodyFont: { size: 14 },
                            padding: 12
                        }
                    }
                }
            });
        }

        let currentInput = "0";
        let previousInput = "";
        let operator = null;
        let shouldResetScreen = false;

        function pressNum(num) {
            if (currentInput === "0" || shouldResetScreen) {
                currentInput = num;
                shouldResetScreen = false;
            } else {
                currentInput += num;
            }
            updateDisplay();
        }

        function pressOp(op, btnElement) {
            if (operator !== null && !shouldResetScreen) calculateResult(); 
            clearOpStyles();
            if (btnElement) {
                btnElement.classList.add('op-active');
            }
            previousInput = currentInput;
            operator = op;
            shouldResetScreen = true;
        }

        function calculateResult() {
            if (operator === null || shouldResetScreen) return;
            let result;
            const prev = parseFloat(previousInput);
            const current = parseFloat(currentInput);

            switch (operator) {
                case '+': result = prev + current; break;
                case '-': result = prev - current; break;
                case '*': result = prev * current; break;
                case '/': result = prev / current; break;
                default: return;
            }

            currentInput = result.toString();
            operator = null;
            updateDisplay();
            clearOpStyles();
        }

        function clearOpStyles() {
            const ops = document.querySelectorAll('.bg-accent'); // æŠ“å–æ‰€æœ‰æ©˜ç´…è‰²çš„é‹ç®—æŒ‰éˆ•
            ops.forEach(btn => btn.classList.remove('op-active'));
        }

        function updateDisplay() {
            const display = document.getElementById('calc-display');
            const converted = document.getElementById('calc-converted');
            const autoConvert = document.getElementById('auto-convert').checked;

            display.innerText = currentInput;

            // åŒ¯ç‡æ›ç®—é‚è¼¯
            if (autoConvert && currentRate) {
                const twd = (parseFloat(currentInput) * currentRate).toLocaleString(undefined, {maximumFractionDigits: 0});
                converted.innerText = `â‰ˆ TWD ${twd}`;
            } else {
                converted.innerText = "";
            }
        }

        function pressDelete() {
            currentInput = currentInput.slice(0, -1);
            if (currentInput === "") currentInput = "0";
            updateDisplay();
        }

        function clearCalc() {
            currentInput = "0";
            previousInput = "";
            operator = null;
            updateDisplay();
            clearOpStyles();
        }

        function pressCalc(cmd) {
            if (cmd === 'C') clearCalc();
            updateDisplay();
        }

        async function toggleCalc() {
            const modal = document.getElementById('calc-modal');
            if (modal.classList.contains('hidden')) {
                await updateLiveRate();
                document.getElementById('rate-tag').innerText = `å¯¦æ™‚åŒ¯ç‡: ${currentRate.toFixed(4)}`;
                modal.classList.replace('hidden', 'flex');
                clearCalc();
            } else {
                modal.classList.replace('flex', 'hidden');
            }
        }

        // ---ç¬¬äºŒåˆ†é ï¼šæ¶ˆè²»æ˜ç´°ç¸½è¦½---
        // æ§åˆ¶åˆ—è¡¨é–‹é—œ
        function toggleExpenseList() {
            const container = document.getElementById('full-expense-list-container');
            const arrow = document.getElementById('expense-list-arrow');
            
            if (container.classList.contains('hidden')) {
                renderFullExpenseList(); // å±•é–‹æ™‚é‡æ–°è¨ˆç®—ä¸¦æ¸²æŸ“
                container.classList.remove('hidden');
                arrow.style.transform = 'rotate(180deg)';
            } else {
                container.classList.add('hidden');
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        // æ¸²æŸ“æ‰€æœ‰æ˜ç´°
        function renderFullExpenseList() {
            const body = document.getElementById('full-expense-list-body');
            body.innerHTML = '';

            if (travelData.events.length === 0) {
                body.innerHTML = '<tr><td colspan="3" class="p-10 text-center text-gray-400">å°šç„¡ä»»ä½•æ¶ˆè²»ç´€éŒ„</td></tr>';
                return;
            }

            // ä¾å¤©æ•¸æ’åºæ‰€æœ‰äº‹ä»¶
            const sortedEvents = [...travelData.events].sort((a, b) => a.day - b.day || a.time.localeCompare(b.time));

            sortedEvents.forEach(event => {
                if (event.expenses && event.expenses.length > 0) {
                    event.expenses.forEach(exp => {
                        const dateText = `Day ${event.day + 1}`;
                        const methodIcon = exp.method === 'ä¿¡ç”¨å¡' ? 'ğŸ’³' : 'ğŸ’µ';
                        
                        const row = `
                            <tr class="border-b border-gray-50 hover:bg-stone-50">
                                <td class="px-6 py-3">
                                    <div class="text-[9px] text-gray-400">${dateText} - ${event.title}</div>
                                    <div class="font-medium">${exp.name}</div>
                                </td>
                                <td class="px-6 py-3 text-xs text-gray-500">${methodIcon} ${exp.method}</td>
                                <td class="px-6 py-3 text-right font-bold text-accent">Â¥ ${exp.amount.toLocaleString()}</td>
                            </tr>
                        `;
                        body.insertAdjacentHTML('beforeend', row);
                    });
                }
            });

            if (body.innerHTML === '') {
                body.innerHTML = '<tr><td colspan="3" class="p-10 text-center text-gray-400">å°šç„¡ä»»ä½•æ¶ˆè²»ç´€éŒ„</td></tr>';
            }
        }

        // --- ç¬¬ä¸‰åˆ†é ï¼šè³¼ç‰©æ¸…å–® --- 
        // åˆå§‹è³‡æ–™çµæ§‹
        let shoppingData = JSON.parse(localStorage.getItem('travelShopping')) || [];
        let currentAddingUser = "";

        // æ‰“é–‹/é—œé–‰å½ˆçª—
        function openShopModal(user) {
            currentAddingUser = user;
            document.getElementById('shop-modal').classList.remove('hidden');
            setHeart(0);
            document.getElementById('photo-input-container').innerHTML = '';
            addPhotoInput('');
        }
        function closeShopModal() {
            document.getElementById('shop-modal').classList.add('hidden');
        }

        // æ‰“é–‹ç·¨è¼¯å½ˆçª—
        function openEditShopModal(itemId) {
            const item = shoppingData.find(i => i.id === itemId);
            if (!item) return;
            const savedHeart = item.heart || 0;
            setHeart(savedHeart);

            // å¡«å……è³‡æ–™
            document.getElementById('edit-item-id').value = item.id;
            document.getElementById('shop-item-name').value = item.name;
            document.getElementById('shop-attr').value = item.attr;
            document.getElementById('shop-cat').value = item.cat;
            document.getElementById('shop-loc').value = item.loc;
            document.getElementById('shop-heart').value = item.heart;
            document.getElementById('photo-input-container').innerHTML = '';
            const urls = item.photoUrls || (item.photoUrl ? [item.photoUrl] : []);
            if (urls.length === 0) addPhotoInput('');
            else urls.forEach(url => addPhotoInput(url));
            // ä¿®æ”¹æ¨™é¡Œèˆ‡æŒ‰éˆ•
            document.getElementById('modal-title').innerText = "ç·¨è¼¯æ¸…å–®é …ç›®";
            document.getElementById('shop-modal').classList.remove('hidden');
            currentAddingUser = item.user; // ç¢ºä¿ç·¨è¼¯å¾Œä»å±¬æ–¼åŒä¸€å€‹äºº
        }

        // å„²å­˜é …ç›® (åŒæ™‚æ”¯æ´æ–°å¢èˆ‡ç·¨è¼¯)
        function saveShopItem() {
            console.log("æ­£åœ¨å˜—è©¦å„²å­˜...");

            // 1. æŠ“å–åç¨±
            const nameEl = document.getElementById('shop-item-name');
            if (!nameEl || !nameEl.value.trim()) {
                alert("è«‹è¼¸å…¥å•†å“åç¨±");
                return;
            }
            const itemName = nameEl.value.trim();

            // 2. æŠ“å–ç…§ç‰‡ç¶²å€ (é€™è£¡æˆ‘æª¢æŸ¥ä¸¦ç¢ºä¿åªå®£å‘Šä¸€æ¬¡)
            let finalPhotoUrls = []; 
            const allPhotoInputs = document.querySelectorAll('.shop-photo-urls'); // æ”¹åé¿å…é‡è¤‡
            if (allPhotoInputs.length > 0) {
                finalPhotoUrls = Array.from(allPhotoInputs)
                                    .map(input => input.value)
                                    .filter(url => url.trim() !== "");
            }

            // 3. å®‰å…¨æŠ“å–å…¶ä»–é¸å–®è³‡æ–™
            const attr = document.getElementById('shop-attr')?.value || "é£Ÿ";
            const cat = document.getElementById('shop-cat')?.value || "ä¸€èˆ¬";
            const loc = document.getElementById('shop-loc')?.value || "å¤§é˜ª";
            const heart = parseInt(document.getElementById('shop-heart')?.value || 0);
            const editIdEl = document.getElementById('edit-item-id');
            const editId = editIdEl ? editIdEl.value : "";

            // 4. æ‰“åŒ…è³‡æ–™
            const itemData = {
                name: itemName,
                photoUrls: finalPhotoUrls,
                attr: attr,
                cat: cat,
                loc: loc,
                heart: heart,
                user: currentAddingUser
            };

            // 5. åˆ¤æ–·æ–°å¢æˆ–æ›´æ–°
            if (editId) {
                const index = shoppingData.findIndex(i => i.id == editId);
                if (index !== -1) {
                    shoppingData[index] = { ...shoppingData[index], ...itemData };
                }
            } else {
                shoppingData.push({
                    id: Date.now(),
                    checked: false,
                    ...itemData
                });
            }

            // 6. å¯«å…¥å„²å­˜ç©ºé–“ä¸¦æ›´æ–°ç•«é¢
            localStorage.setItem('travelShopping', JSON.stringify(shoppingData));

            if (typeof db !== 'undefined') {
                db.ref('shoppingData').set(shoppingData)
                .then(() => {
                    console.log("è³¼ç‰©è³‡æ–™å·²åŒæ­¥è‡³é›²ç«¯");
                    closeShopModal();
                })
                .catch((error) => {
                    console.error("åŒæ­¥å¤±æ•—ï¼š", error);
                    closeShopModal();
                });
            } else {
                closeShopModal();
                const shopSection = document.getElementById('section-shopping');
                if (shopSection && !shopSection.classList.contains('hidden')) {
                    renderShopping();
                }
            }
        }
        function toggleUserList(user) {
            shoppingVisibility[user] = !shoppingVisibility[user];
            
            // æ›´æ–°çœ¼ç›åœ–ç¤º
            const eyeIcon = document.getElementById(`eye-${user}`);
            if (eyeIcon) {
                eyeIcon.className = shoppingVisibility[user] ? 'fas fa-eye' : 'fas fa-eye-slash text-gray-300';
            }
            
            renderShopping(); // é‡æ–°æ¸²æŸ“
        }

        function renderShopping(filterKeyword = 'ALL') {
            const shoppingSection = document.getElementById('section-shopping');
            // ğŸ›‘ é˜²è­·å‚˜ï¼šå¦‚æœè³¼ç‰©åˆ†é æ˜¯éš±è—çš„ï¼Œå°±ä¸æº–åŸ·è¡Œæ¸²æŸ“
            if (shoppingSection && shoppingSection.classList.contains('hidden')) return;

            updateFilterOptions();
            const ids = ['shop-list-A', 'shop-list-B', 'shop-list-C'];
            const users = ['User A', 'User B', 'User C'];

            users.forEach((user, index) => {
                const container = document.getElementById(ids[index]);
                if (!container) return;
                if (!shoppingVisibility[user]) {
                    container.innerHTML = `
                        <div class="py-4 text-center text-[10px] text-gray-300 italic border border-dashed border-gray-100 rounded-xl">
                            å…§å®¹å·²éš±è—
                        </div>`;
                    return;
                }

                container.innerHTML = '';
                let userItems = shoppingData.filter(item => {
                    const isUser = item.user === user;
                    if (filterKeyword === 'ALL') return isUser;
                    const heartStr = "â¤ï¸".repeat(item.heart);
                    return isUser && (item.loc === filterKeyword || item.attr === filterKeyword || item.cat === filterKeyword || heartStr.includes(filterKeyword));
                });
                userItems.sort((a, b) => a.checked - b.checked);
                userItems.forEach(item => {
                    const heartStr = "â¤ï¸".repeat(item.heart) || "ğŸ¤ğŸ¤ğŸ¤";
                    const urls = item.photoUrls || (item.photoUrl ? [item.photoUrl] : []);
                    let photoHtml = '';
                    if (urls.length > 0) {
                        photoHtml = `<div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar mb-2">
                            ${urls.map(url => `<img src="${url}" ondblclick="openLightbox('${url}')" class="w-32 h-32 object-cover rounded-xl border border-gray-100 shrink-0 cursor-zoom-in ${item.checked ? 'opacity-50 grayscale-[0.5]' : ''}" onerror="this.src='https://placehold.co/400x400?text=Image+Error'">`).join('')}
                        </div>`;
                    }
                    const card = `
                        <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 mb-3 transition-all ${item.checked ? 'bg-gray-50/50 border-dashed opacity-70' : ''}">
                            ${photoHtml}
                            <div class="flex justify-between items-start mb-2">
                                <span class="font-bold ${item.checked ? 'text-gray-400 line-through' : 'text-gray-800'}">${item.name}</span>
                                <div class="flex gap-4 items-center">
                                    <button onclick="openEditShopModal(${item.id})" class="text-gray-300 hover:text-blue-500 text-lg"><i class="fas fa-edit"></i></button>
                                    <input type="checkbox" onchange="toggleItemCheck(${item.id})" ${item.checked ? 'checked' : ''} class="w-5 h-5 rounded-lg border-gray-300 text-[#8E2B2B]">
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-1 ${item.checked ? 'grayscale opacity-50' : ''}">
                                <span class="text-[9px] bg-blue-50 text-blue-500 px-1.5 py-0.5 rounded">ğŸ“ ${item.loc}</span>
                                <span class="text-[9px] bg-orange-50 text-orange-500 px-1.5 py-0.5 rounded">ğŸ·ï¸ ${item.cat}</span>
                                <span class="text-[9px] bg-red-50 text-red-500 px-1.5 py-0.5 rounded">${heartStr}</span>
                            </div>
                        </div>`;
                    container.insertAdjacentHTML('beforeend', card);
                });
            });
        }    

        // ğŸŒŸ é…åˆä½¿ç”¨çš„è‡ªå‹•æ›´æ–°é¸å–®å‡½æ•¸ (è¨˜å¾—ä¹Ÿè¦åŠ ä¸Šé€™æ®µ)
        function updateFilterOptions() {
            const catSelect = document.getElementById('filter-cat');
            if (!catSelect) return;
            
            // å–å¾—ç›®å‰æ‰€æœ‰é …ç›®ä¸­ã€Œä¸é‡è¤‡ã€çš„å­åˆ†é¡
            const categories = [...new Set(shoppingData.map(item => item.cat))].filter(c => c && c.trim() !== "");
            
            // ä¿ç•™é è¨­é¸é …ï¼Œæ¸…ç©ºèˆŠçš„è‡ªå®šç¾©é¸é …
            catSelect.innerHTML = '<option value="ALL">ğŸ” æ‰€æœ‰å­åˆ†é¡</option>';
            
            categories.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat;
                opt.innerText = cat;
                catSelect.appendChild(opt);
            });
        }
        
        function toggleItemCheck(id) {
            const item = shoppingData.find(i => i.id === id);
            if (item) {
                item.checked = !item.checked;
                localStorage.setItem('travelShopping', JSON.stringify(shoppingData));
                renderShopping();
            }
        }
        //æ–°å¢å¤šå€‹ç¶²å€
        function addPhotoInput(url = '') {
            const container = document.getElementById('photo-input-container');
            const div = document.createElement('div');
            div.className = "flex gap-2";
            div.innerHTML = `
                <input type="text" value="${url}" placeholder="https://..." class="shop-photo-urls flex-1 p-3 bg-gray-50 rounded-xl text-sm">
                <button onclick="this.parentElement.remove()" class="text-gray-400 px-2"><i class="fas fa-minus-circle"></i></button>
            `;
            container.appendChild(div);
        }
            // åœ¨æ‰“é–‹å½ˆçª—æ™‚åˆå§‹åŒ–
        function resetPhotoInputs(urls = []) {
            const container = document.getElementById('photo-input-container');
            container.innerHTML = ''; // å…ˆæ¸…ç©º
            if (urls.length === 0) {
                addPhotoInput(''); // é è¨­çµ¦ä¸€å€‹ç©ºçš„
            } else {
                urls.forEach(url => addPhotoInput(url));
            }
        }

        //å–œæ„›ç¨‹åº¦
        function setHeart(val) {
            const heartInput = document.getElementById('shop-heart');
            const heartBtns = document.querySelectorAll('.heart-emoji-btn');
            const heartTag = document.getElementById('heart-tag');
            
            // å¦‚æœé»é¸ç›®å‰çš„æ•¸å€¼ï¼Œå‰‡é‡ç½®ç‚º 0 (æ–¹ä¾¿å–æ¶ˆ)
            let finalVal = (heartInput.value == val) ? 0 : val;
            heartInput.value = finalVal;

            // æ›´æ–° Emoji ç‹€æ…‹
            heartBtns.forEach((btn, index) => {
                if (index < finalVal) {
                    btn.innerText = "â¤ï¸"; // è®Šç´…å¿ƒ
                    btn.classList.add('heart-active');
                } else {
                    btn.innerText = "ğŸ¤"; // å›ç™½å¿ƒ
                    btn.classList.remove('heart-active');
                }
            });

            // æ›´æ–°æ–‡å­—èˆ‡å¯æ„›æ¨™ç±¤é¡è‰²
            const statusData = [
                { text: "çœ‹çœ‹", color: "text-gray-300", bg: "bg-white" },
                { text: "å¿ƒå‹•", color: "text-pink-400", bg: "bg-pink-100" },
                { text: "æƒ³è¦", color: "text-pink-500", bg: "bg-pink-200" },
                { text: "å¿…è²·", color: "text-white", bg: "bg-[#8E2B2B]" }
            ];
            
            const status = statusData[finalVal];
            heartTag.innerText = status.text;
            heartTag.className = `ml-2 px-3 py-1 rounded-full text-[10px] font-extrabold shadow-sm border border-pink-100 transition-all ${status.color} ${status.bg}`;
        }

        //é›™æ“Šæ”¾å¤§åœ–ç‰‡
            // æ‰“é–‹ç‡ˆç®±
        function openLightbox(url) {
            const lightbox = document.getElementById('image-lightbox');
            const img = document.getElementById('lightbox-img');
            if (!lightbox || !img) return;

            img.src = url;
            lightbox.classList.remove('hidden');
           
            // åŠ ä¸Šä¸€å€‹æ·¡å…¥æ•ˆæœ
            lightbox.style.opacity = '0';
            setTimeout(() => {
                lightbox.style.transition = 'opacity 0.3s ease';
                lightbox.style.opacity = '1';
            }, 10);
        }

            // é—œé–‰ç‡ˆç®±
        function closeLightbox() {
            const lightbox = document.getElementById('image-lightbox');
            if (lightbox) {
                lightbox.style.opacity = '0';
                setTimeout(() => {
                    lightbox.classList.add('hidden');
                }, 300);
            }
        }

        // ä¸€éµç¯©é¸
        function filterShopping(keyword) {
            renderShopping(keyword);
        }

        // --- é€šç”¨ ---
        function changeTotalDays(delta) {
            travelData.totalDays = Math.max(1, travelData.totalDays + delta);
            saveData(); renderDateNav();
        }

        function updateStartDate(date) {
            if (date) { travelData.startDate = date; saveData(); renderDateNav(); }
        }

        function saveData() {
            localStorage.setItem('myTravelEvents', JSON.stringify(travelData.events));
            localStorage.setItem('startDate', travelData.startDate);
            localStorage.setItem('totalDays', travelData.totalDays);
            if (typeof db !== 'undefined') {
                db.ref('travelData').set(travelData)
                .then(() => console.log("é›²ç«¯è¡Œç¨‹åŒæ­¥æˆåŠŸï¼"))
                .catch((error) => console.error("åŒæ­¥å¤±æ•—ï¼š", error));
            }
        }

        function exportData() {
            const data = JSON.stringify(localStorage);
            const blob = new Blob([data], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `travel_backup_${new Date().toLocaleDateString()}.json`;
            a.click();
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = readerEvent => {
                    const content = JSON.parse(readerEvent.target.result);
                    Object.keys(content).forEach(key => {
                        localStorage.setItem(key, content[key]);
                    });
                    alert('åŒ¯å…¥æˆåŠŸï¼ç¶²é å°‡é‡æ–°è¼‰å…¥');
                    location.reload();
                };
                reader.readAsText(file);
            };
            input.click();
        }
        window.onload = function() {
            renderDateNav();
            renderEvents();
            startClock();       // å•Ÿå‹•æ™‚é˜
            updateHeaderInfo();
            updateDetailedWeather();
            const shopSection = document.getElementById('section-shopping');
            if (shopSection && !shopSection.classList.contains('hidden')) {
                renderShopping();
            }
        }; // ğŸŒŸ é€™æ˜¯ window.onload çš„çµæŸ
    </script>
</body>
</html>



